<!DOCTYPE html>
<html lang="en">
<head>
    <!-- 
        {{FLOWC_NAME}} v{{FLOWC_VERSION}} ({{FLOWC_BUILD}})
        Generated from {{INPUT_FILE}} ({{MAIN_FILE_TS}})
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta charset="utf-8">
    <title>{{NAME/upper}} [REST Gateway]</title>

    <!-- Mobile Specific Metas
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Fonts
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->

    <!-- CSS 
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.3.1/litera/bootstrap.css">
    <style>
        div[data-schemaid=root]>h3{ display: none; }
        div[data-schemaid=root]>p{ font-size: 125%; font-weight: bold; }
        div.pr-button { width: 220px; margin-left: 0px; margin-right: 20px; margin-top: 8px; display: inline-block; vertical-align: top; }
        p.form-text,  
        .pr-button-text {  font-style: italic; font-size: 75%;  white-space: normal; }
        label { font-weight: bold; }
        .pr-stick-on { position: relative; white-space: nowrap;  }
        .pr-stick-right { top: 0; right:0; position: absolute; }
        @media (max-width: 770px) {
            div.pr-button { display: block; }
        }
        p {  font-family: unset; }

        .pr-message-good { font-size: 90%; font-weight: bold; color: blue; }
        .pr-message-error { font-size: 90%; font-weight: bold; color: red; }
        #pr-message { margin-left: 24px; }
        #pr-message-details { margin-left: 24px; }

        #pr-response { font-size: 90%;  white-space: normal; }
        .pr-sticky, .pr-JSON-boolean, .pr-JSON-number, .pr-JSON-null { margin-right: 12px;  display: inline-block; }
        .pr-JSON-boolean { color: orange; }
        .pr-JSON-number { font-weight: bold; }
        .pr-JSON-null { color: red; }
        .pr-JSON-string { white-space: pre; }
        .pr-JSON-key { font-weight: bold; font-style: italic; }
        .pr-JSON-array {  }
        .pr-JSON-object { margin-left: 24px;  }
        #pr-stage-time { font-weight: normal; font-size: 75% }
        .pr-stage-time { margin-left: 24px; }
    </style>
</head>
<body>
    <!-- Navigation Bar
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div id="pr-header-id" class="pr-header">
        <nav class="navbar navbar-expand-sm">
            <div class="navbar-nav mr-auto"><h3>{{NAME/upper}}{A:HAVE_ACTIVE_NODE{ - {{MAIN_ENTRY_NAME/upper}}}A}</h3></div>  
            <div class="navbar-expand ml-auto" id="advanced-menu">
                <ul id="pr-nav-links" class="nav navbar-nav navbar-expand">
{A:HAVE_ACTIVE_NODE{
                    <li class="nav-item" id="home-menu">
                        <a id="pr-home-link" class="nav-link" href="/-www/index.html">{{NAME}}</a>
                    </li>
}A}

{N:HAVE_CLI{{{HAVE_CLI}}
                    <li class="nav-item dropdown" id="nodes-dropdown">
                        <a id="pr-nodes-link" class="nav-link dropdown-toggle" href="#" data-toggle="dropdown"><i class="ui-icon-gear"></i>Nodes<b class="caret"></b></a>
                        <div id="pr-nodes-menu" class="dropdown-menu dropdown-menu-right">
                            <h5 class="dropdown-header">Internal Nodes</h5>
{C:CLI_NODE_NAME{
                            <a class="dropdown_item doc-selector" href="/-www/{{CLI_NODE_NAME}}-index.html">{{CLI_NODE_NAME}}</a>
                            <i>{{CLI_NODE_DESCRIPTION}}</i>
                            <br>
}C}
                        </div>
                    </li>
}N}
                    <li class="nav-item dropdown" id="graphs-dropdown">
                        <a id="pr-graphs-link" class="nav-link dropdown-toggle" href="#" data-toggle="dropdown"><i class="ui-icon-gear"></i>Graphs<b class="caret"></b></a>
                        <div id="pr-graphs-menu" class="dropdown-menu dropdown-menu-right">
                            <h5 class="dropdown-header">Node Connection Graphs</h5>
{I:ENTRY_NAME{
                            <a class="dropdown_item doc-selector" href="/-docs/{{ENTRY_NAME}}.svg">{{ENTRY_NAME}}</a>
                            <br>
}I}
                        </div>
                    </li>
                    <li class="nav-item dropdown" id="sources-dropdown">
                        <a id="pr-docs-link" class="nav-link dropdown-toggle" href="#" data-toggle="dropdown"><i class="ui-icon-gear"></i>Sources<b class="caret"></b></a>
                        <div id="pr-docs-menu" class="dropdown-menu dropdown-menu-right">
                            <h5 class="dropdown-header">Source Files</h5>
                            <a class="dropdown_item doc-selector" href="/-docs/{{MAIN_FILE}}">{{MAIN_FILE}}</a>
                            <i>{{NAME}} flow file</i>
                            <br>
{P:PROTO_FILE{
                            <a class="dropdown_item doc-selector" href="/-docs/{{PROTO_FILE}}">{{PROTO_FILE}}</a> 
                            <i>{{PROTO_FILE_DESCRIPTION}}</i>
                            <br>
}P}
                        </div>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
    <!-- Form Section
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div class="pr-panel">
        <div>
            <form method="post" action="#">
                <div id="pr-form-editor" class="m-4"></div>
            </form>
            <div id="pr-form-submit" class="m-4 pr-stick-on">
                <div class="form-group pr-button">
                    <button type="button" class="btn btn-primary btn-block" value="{{MAIN_ENTRY_NAME}}" id="{{MAIN_ENTRY_NAME}}-submit" 
                    style="width: 200px; border-radius: 20px;">{{MAIN_ENTRY_NAME/decamelize}}</button>
                    <span class="pr-button-text">{{MAIN_ENTRY_DESCRIPTION/html}}</span>
                </div>
{I:ALT_ENTRY_NAME{              
                <div class="form-group pr-button">
                    <button type="button" class="btn btn-primary btn-block" value="{{ALT_ENTRY_NAME}}" id="{{ALT_ENTRY_NAME}}-submit" 
                    style="width: 200px; border-radius: 20px;">{{ALT_ENTRY_NAME/decamelize}}</button>
                    <span class="pr-button-text">{{ALT_ENTRY_DESCRIPTION/html}}</span>
                </div>
}I}
                <div class="form-group pr-button pr-debug-button pr-stick-right">
                    <!--input type="checkbox" id="overlapped-calls" checked><span class="pr-button-text"> Overlapped gRPC Calls</span><br-->
                    <input type="checkbox" id="advanced-view" checked><span class="pr-button-text"> Advanced View</span><br>
                </div>
            </div>
        </div>
    </div>
    <hr>
    <!-- Messages Section
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div id="pr-message-panel" class="pr-view-panel">
        <div class="m-4">
            <div class="row" id="pr-message"></div>
            <div class="row" id="pr-message-details"></div>


            <div class="row">
                <div id="pr-timing" class="col-xl-8">
                    <div>
                        <span id="pr-stage-time">
                        </span>
                    </div>
                </div>
                <div class="col-xl-4 float-right">
                    <button class="btn btn-outline-success btn-sm ml-auto mb-2 mr-2" id="download-request" style="display: none;" type="button">Download JSON Request</button>
                    <button class="btn btn-outline-success btn-sm mr-2 mb-2" id="download-response" style="display: none;" type="button">Download JSON Response</button>
                </div>
            </div>

        </div>
    </div>
        <div id="pr-extra" class="pr-view-panel"></div>
    <hr>
    <!-- Results Section
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div id="pr-view" class="pr-view-panel">
        <div id="pr-response"></div>
    </div>
    <!-- End Document
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-jsonview/1.2.3/jquery.jsonview.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-json-editor/1.1.0/jquery-json-editor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@1.3.5/dist/jsoneditor.min.js"></script>
    <script>
        var ui_data = {
            "request-schema": {{MAIN_ENTRY_INPUT_SCHEMA_JSON}},
            "methods": [
                {
                    "name": "{{MAIN_ENTRY_NAME}}",
                    "url": "{{MAIN_ENTRY_URL}}",
                    "response-schema": {{MAIN_ENTRY_OUTPUT_SCHEMA_JSON}}
                }
{I:ALT_ENTRY_NAME{               ,{
                    "name": "{{ALT_ENTRY_NAME}}",
                    "url": "{{ALT_ENTRY_URL}}",
                    "response-schema": {{ALT_ENTRY_OUTPUT_SCHEMA_JSON}}
                }
}I}
            ]
        };
    window.PR = {
        ui_data: null,
        init: function(data) {
            PR.ui_data = data;
            JSONEditor.defaults.iconlibs.oi = JSONEditor.AbstractIconLib.extend({
                mapping: {
                    "delete": 'delete',
                    edit: 'pencil',
                    add: 'plus',
                    cancel: 'ban',
                    save: 'save',
                    moveup: 'arrow-thick-up',
                    movedown: 'arrow-thick-down',
                    clear: 'circle-x',
                    time: 'timer',
                    calendar: 'calendar',
                    upload: 'cloud-upload',
                },
                icon_class: 'oi',
                icon_prefix: 'oi oi-'
            });
        },
        prepareSchema: function(schema) {
            if('type' in schema && !('format' in schema) && schema['type'] === 'string') {
                schema['format'] = 'textarea';
            } 
            if('type' in schema && schema['type'] === 'object') {
                properties = schema['properties'];
                for([key, val] of Object.entries(properties)) 
                    PR.prepareSchema(val);
            }
            if('type' in schema && schema['type'] === 'array') {
                PR.prepareSchema(schema['items']);
            }
        },
        advancedFields: [],
        findAdvancedFields: function(schema, prefix) {
            if('type' in schema && schema['type'] === 'object') {
                properties = schema['properties'];
                for([key, val] of Object.entries(properties)) 
                    PR.findAdvancedFields(val, prefix + '.' + schema['title']);
            } else 
            if('type' in schema && schema['type'] === 'array') {
                PR.findAdvancedFields(schema['items'], prefix + '.' + schema['title']);
            } else 
            if('type' in schema && !('default' in schema)) {
                PR.advancedFields.push(prefix + '.' + schema['title']);
            }
        },
        makeForm: function() {
            var rqt_schema = PR.ui_data["request-schema"];
            rqt_schema["format"] = "grid";
            PR.prepareSchema(rqt_schema);
            for([key, val] of Object.entries(rqt_schema["properties"])) 
                PR.findAdvancedFields(val, "root");
            PR.form = new JSONEditor($('#pr-form-editor')[0], {
                "schema" : rqt_schema,
                "theme" : "bootstrap4",
                "iconlib" : "oi",
                "template" : "handlebars",
                "disable_properties" : true,
                "disable_edit_json" : true
            });
        },
        appendOrReplace: function(obj, cont, repl) {
            if(repl) {
                obj.replaceWith(cont);
            } else {
                obj.html(obj.html()+cont);
            }
            return obj;
        },
    renderJSON: function(schema, container, label, objectID, jo, replace, keyO) {
        if(typeof jo === 'boolean') {
            PR.appendOrReplace(container, '<div class="pr-JSON-boolean" id="'+objectID+'">'+jo+"</div>", replace);
            if(keyO) keyO.addClass("pr-sticky");
            $("#"+objectID).addClass(label);
        } else 
        if(typeof jo === 'string' || jo instanceof String) {
            PR.appendOrReplace(container, '<div class="pr-JSON-string" id="'+objectID+'"></div>', replace);
            $("#"+objectID).attr('data-text', jo);
            if(keyO && jo.length < 100 && jo.indexOf(' ') < 0) {
                keyO.addClass("pr-sticky");
                $("#"+objectID).addClass("pr-sticky");
                $("#"+objectID).text(jo);
            } else {
                $("#"+objectID).addClass("pr-wrappable");
                $("#"+objectID).html(jo.replace(/(?:\r\n|\r|\n)/g, '<br>')); 
            }
            $("#"+objectID).addClass(label);
         } else 
         if(typeof jo === 'number' && isFinite(jo)) {
             PR.appendOrReplace(container, '<div class="pr-JSON-number" id="'+objectID+'">'+jo+"</div>", replace);
             if(keyO) keyO.addClass("pr-sticky");
             $("#"+objectID).addClass(label);
         } else 
         if(jo && typeof jo === 'object' && jo.constructor === Array) {
             var lc = 0;
             PR.appendOrReplace(container, '<div class="pr-JSON-array" id="'+objectID+'"></div>', replace);
             $("#"+objectID).addClass(label);
             container = $("#"+objectID);
             if(schema && 'type' in schema && schema['type'] === 'array' && 'items' in schema) 
                 schema = schema['items'];
             else 
                 schema = null;
             for(const jao of jo) {
                 lc = lc + 1;
                 var localID = objectID + "-" + lc;
                 PR.renderJSON(schema, container, label + "-", localID, jao, false, null);
             }
         } else
         if(jo && typeof jo === 'object' && jo.constructor === Object) {
             var lc = 0;
             PR.appendOrReplace(container, '<div class="pr-JSON-object" id="'+objectID+'"></div>', replace);
             $("#"+objectID).addClass(label);
             container = $("#"+objectID);
             var properties = null;
             if(schema && 'type' in schema && schema['type'] === 'object') 
                 properties = schema['properties'];

             if(properties) {
                 var s = 0;
                 for(const [key, val] of Object.entries(properties)) 
                     if('propertyOrder' in val && val.propertyOrder > s) s = val.propertyOrder; 
                 for([key, val] of Object.entries(properties)) 
                     if(!('propertyOrder' in val)) {val['propertyOrder'] = s; s += 1;} 
                 properties = Array.from(Object.keys(properties), x => [x, properties[x]]);

                 properties.sort(function(a, b) {
                     return a[1].propertyOrder - b[1].propertyOrder;
                 });

                 for(const [key, prop] of properties) {
                     lc = lc + 1;
                     if(key in jo) {
                         var val = jo[key];
                         var localIDk = objectID+'-k'+lc;
                         var localIDv = objectID+'-v'+lc;
                         PR.appendOrReplace(container, '<div class="pr-JSON-key" id="'+localIDk+'"></div><div id="'+localIDv+'"></div>', false);
                         var ko = $("#"+localIDk);
                         ko.text(key); 
                         ko.addClass('k' + label + '-' + key);
                         schema = prop;
                         if('description' in schema) 
                             ko.attr('title', schema['description']);
                         PR.renderJSON(schema, $("#"+localIDv), label + '-' + key, localIDv, val, true, ko);
                     }
                 }

             } else {
                 for(const [key, val] of Object.entries(jo)) {
                     lc = lc + 1;
                     var localIDk = objectID+'-k'+lc;
                     var localIDv = objectID+'-v'+lc;
                     PR.appendOrReplace(container, '<div class="pr-JSON-key" id="'+localIDk+'"></div><div id="'+localIDv+'"></div>', false);
                     var ko = $("#"+localIDk);
                     ko.text(key); 
                     ko.addClass('k' + label + '-' + key);
                     if(properties && key in properties) 
                         schema = properties[key];
                     else
                         schema = null;
                     if(schema && 'description' in schema) {                         
                         ko.attr('title', schema['description']);
                     }
                     PR.renderJSON(schema, $("#"+localIDv), label + '-' + key, localIDv, val, true, ko);
                 }
             }
         } else {
             PR.appendOrReplace(container, '<div class="pr-JSON-null" id="'+objectID+'">null</div>', replace);
         }
    },
        connectButtons: function() {
            /* submit on <Return> in the main filed if any */
            /*
            $('*[data-schemapath="root.question"]').on("keydown", function(event) {
                var keycode = event.keyCode || event.which;
                if (keycode == 13) {
                    $("#answer_extraction-submit").focus(); 
                    $("#answer_extraction-submit").click();
                    $(this).focus();
                }
            });
            */
            $('#advanced-view').change(function() { 

                if(this.checked) {
                    //$('*[data-schemapath="root.question"]').removeClass("col-md-8");
                    //$('*[data-schemapath="root.question"]').addClass("col-md-4");
                    for(const afid of PR.advancedFields)
                        $('*[data-schemapath="'+afid+'"]').show();
                    $("#advanced-menus").show();
                    $("#pr-message-panel").show();
                    // Show/hide alternate entries
                    //$("#article_retrieval-submit").parent().show();
                    /*
                    $('.pr-JSON-key').show();
                    if(PR.hideFields.length > 0)
                        $('.' + PR.hideFields.join(',.')).show();
                   */
                 } else {
                    //$('*[data-schemapath="root.question"]').removeClass("col-md-4");
                    //$('*[data-schemapath="root.question"]').addClass("col-md-8");
                    for(const afid of PR.advancedFields)
                        $('*[data-schemapath="'+afid+'"]').hide();
                    $("#advanced-menus").hide();
                    $("#pr-message-panel").hide();
                    //$("#article_retrieval-submit").parent().hide();
                    /*
                    if(PR.alwaysShowKeys.length > 0) {
                        $('.pr-JSON-key:not(.' + PR.alwaysShowKeys.join(',.')+')').hide();
                    } else {
                        $('.pr-JSON-key').hide();
                    }
                    if(PR.hideFields.length > 0)
                        $('.' + PR.hideFields.join(',.')).hide();
                    */
                }
            });
            $('#download-response').on('click', function() {
                var a = document.createElement("a");
                var docstr = JSON.stringify(PR.response);
                a.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(docstr));
                a.setAttribute('download', "response.json");
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
            $('#download-request').on('click', function() {
                var a = document.createElement("a");
                var docstr = JSON.stringify(PR.request);
                a.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(docstr));
                a.setAttribute('download', "request.json");
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
            $("#clear-button").on("click", function(e) { 
                PR.acedoc = {};
                $("#pr-message").html('');
                $("#pr-stage-time").html('');
                $("#acedoc-view").html('');
                $("#download-response").hide();
                $("#download-request").hide();
            });
            PR.ui_data.methods.map(function(m) {
                $("#"+m.name+"-submit").on("click", function(e) { 
                    $('html, body').animate({
                        scrollTop: $("#pr-view").offset().top
                    }, 2000);
                    PR.request = PR.form.getValue();
                    var rqtstr = JSON.stringify(PR.request);
                    try { 
                        var xhr = $.ajax({
                            type: "POST",
                            url: m.url,
                            data: rqtstr,
                            cache: false,
							contentType: "application/json",
                            beforeSend: function(request) {
                                request.setRequestHeader("x-flow-time-call", "true");
                                /*
                                if($('#overlapped-calls').is(":checked")) {
                                    request.setRequestHeader("x-flow-overlapped-calls", "1");
                                } else {
                                    request.setRequestHeader("x-flow-overlapped-calls", "0");
                                }
                                */
                                $("#pr-stage-time").html('');
                                $("#pr-response").html('');
                                $("#pr-message").html('<p class="pr-message-good">Sending request...</p>');
                                $("#download-response").hide();
                                $("#download-request").hide();
                            },
                            success: function(reply_obj, sts, jqxhr) {
                                $("#pr-message").html('');
                                PR.response = reply_obj;
                                PR.responseSchema = m["response-schema"];
                                PR.beforeRender();
                                PR.renderJSON(PR.responseSchema, $("#pr-response"), "m", "pr-response", reply_obj, true, null);
                                $('#download-request').show();
                                $('#download-response').show();
                                try {
                                    call_times = jqxhr.getResponseHeader('x-flow-call-times');
                                    call_times = JSON.parse(call_times);
                                    var times_html = '';                    
                                    call_times.forEach(function(to) {
                                         if(to.stage == 0) 
                                            times_html = times_html + " <span class='pr-stage-time'> "+to['stage-name']+": <b>"+to['duration-u']+"</b> </span>";
                                    });
                                    if(call_times.length > 2) call_times.forEach(function(to) {
                                        if(to.stage != 0) {             
                                            times_html = times_html + " <span class='pr-stage-time'> "+to['stage-name']+": <b>"+to['duration-u']+"</b> </span>";
                                        }
                                    });
                                    $("#pr-stage-time").html(times_html);
                                                          
                                } catch(ae) {
                                }
                                PR.afterRender();
                                $('html, body').animate({
                                    scrollTop: $("#pr-view").offset().top
                                }, 2000);
                            },
							error: function(jqXHR, sts, exc) {
                                var emsg = (sts == null ? "error" : sts);
                                if(jqXHR.responseJSON != undefined) {
                                    emsg = jqXHR.responseJSON;
                                }
                                var details = '';
                                if(emsg && typeof emsg === 'object' && emsg.constructor === Object) {
                                    if('code' in emsg && emsg['code'] == 500) {
                                        details = emsg["details"]; 
                                        emsg = '[' + emsg["from"] + '] gRPC Error ' + emsg["grpc-code"] + ': ' + emsg['message'];
                                    } else {
                                        emsg = JSON.stringify(emsg);
                                    }
                                }
                                PR.printError(emsg, details);
                            }
                        });
					} catch (ae) {
						PR.printError("system error");
					}
                    
                });
            });
        },
        printError: function(msg, description) {
            alert(msg+'\n'+description);
            $("#pr-message").html('<p class="pr-message-error">'+msg+"</p>");
            $("#pr-message-details").text(description);
        },
        /***
         * PR.request, PR.response and PR.responseSchema are set 
         * for both beforeRender and afterRender
         */
        beforeRender: function() {
        },
        afterRender: function() {
        }
    };
    PR.init(ui_data);
    PR.makeForm();
    PR.connectButtons();

    /* start in basic mode */
    $("#advanced-view").prop("checked", false).trigger("change");
    </script>
</body>
</html>
