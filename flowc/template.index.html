<!DOCTYPE html>
<html lang="en">
<head>
    <!-- 
        {{FLOWC_NAME}} v{{FLOWC_VERSION}} ({{FLOWC_BUILD}})
        Generated from {{MAIN_FILE_SHORT}} ({{MAIN_FILE_TS}})
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta charset="utf-8">
    <title>{{NAME/upper}} [REST Gateway]</title>

    <!-- Mobile Specific Metas
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Fonts
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->

    <!-- CSS 
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.1.3/flatly/bootstrap.min.css" title="bstheme">
    <style>
        div[data-schemaid=root]>h3{ display: none; }
        div[data-schemaid=root]>p{ display: none; font-size: 125%; font-weight: bold; }
        div.pr-button { width: 220px; margin-left: 0px; margin-right: 20px; margin-top: 8px; display: inline-block; vertical-align: top; }
        div[data-schematype=array]>p,
        .form-text,  
        .pr-button-text {  font-style: italic; font-size: 75%;  white-space: normal;
            color: #95a5a6;
        }
        .pr-switch {  font-style: italic; font-size: 75%;  white-space: normal;  font-weight: normal; 
        }
        label { font-weight: bold; }
        .pr-stick-on { position: relative; white-space: nowrap;  }
        .pr-stick-right { top: 0; right:0; position: absolute; }
        @media (max-width: 770px) {
            div.pr-button { display: block; }
        }
        p {  font-family: unset; }
        div[data-schematype=array]>h3>span, div[data-schematype=array]>h3>label, div[data-schematype=object]>h3>label {font-weight: bold; font-size: 60%;  white-space: normal; }
        div[data-schematype=array] div>h3>label {display: none; }
        .btn-primary { background-color: black; border-color: black;}
        .btn-secondary { border-radius: 0.4em; padding: 2px; margin: 0; border 0;}
        .btn-secondary>span { font-style: italic; font-size: 50%;  white-space: normal; }
        .btn-group { vertical-align: bottom; padding :0; }

        .pr-message-good { font-size: 90%; font-weight: bold; color: blue; }
        .pr-message-error { font-size: 90%; font-weight: bold; color: red; }
        #pr-message { margin-left: 24px; }
        #pr-message-details { margin-left: 24px; }

        #pr-response { font-size: 90%;  white-space: normal; }
        .pr-sticky, .pr-JSON-boolean, .pr-JSON-number, .pr-JSON-null { margin-right: 12px;  display: inline-block; }
        .pr-JSON-boolean { color: orange; }
        .pr-JSON-number { font-weight: bold; }
        .pr-JSON-null { color: red; }
        .pr-JSON-string { white-space: pre; }
        .pr-JSON-key { font-weight: bold; font-style: italic; }
        .pr-JSON-array {  }
        .pr-JSON-object { margin-left: 24px;  }
        #pr-stage-time { font-weight: normal; font-size: 75% }
        .pr-stage-time { margin-left: 24px; }
    </style>
</head>
<body>
    <!-- Navigation Bar
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div id="pr-header-id" class="pr-header">
        <nav class="navbar ms-4 me-4">
            <span class="navbar-brand"><b>{{MAIN_DESCRIPTION/html+NAME/upper/decamelize/html}}</b>{A:HAVE_ACTIVE_NODE{ <span><i>{{MAIN_ENTRY_NAME/upper}}</i></span>}A}</span>
            <div class="navbar-expand me-auto" id="advanced-menu">
                <ul id="pr-nav-links" class="nav navbar-nav navbar-expand">
                    <li class="nav-item dropdown">
                        <a id="pr-menu" class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="oi oi-menu"></span></a>
                        <div id="pr-menu-items" class="dropdown-menu dropdown-menu-right" aria-labelledby="pr-menu">
                            <a class="dropdown-item node-item" href="#" data-name=""><b>{{NAME}}</b></a>
                            <div class="dropdown-divider"></div>
{C:CLI_NODE_NAME{
                            <a class="dropdown-item node-item" href="#" data-name="{{CLI_NODE_NAME/id/lower/option}}">{{CLI_NODE_NAME}}</a>
                            <!-- >{{CLI_NODE_DESCRIPTION/html}}</ -->
}C}
                            <div class="dropdown-divider"></div>
{I:ENTRY_NAME{    
                            <a class="dropdown-item" href="/-proto/{{ENTRY_NAME}}">{{ENTRY_NAME}}.proto</a> 
}I}
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="/-proto/">{{NAME}}.proto</a>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="m-1">
            </div>
            <div class="form-switch ms-auto m-1">
                <input type="checkbox" id="advanced-view" class="form-check-input"><label for="advanced-view" class="ms-2 me-3"><span class="oi oi-cog"></span></label>
            </div>
            <div class="form-switch m-1">
                <input type="checkbox" id="dark-light-view" class="form-check-input"><label for="dark-light-view" class="ms-2"><span class="oi oi-moon"></span></label>
            </div>
        </nav>
    </div>
    <!-- Form Section
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div class="pr-panel">
        <div>
            <form method="post" action="#">
                <div id="pr-form-editor" class="m-4"></div>
            </form>
            <div id="pr-form-submit" class="m-4 pr-stick-on">
                <div class="form-group pr-button main-button">
                    <button type="button" class="btn btn-primary btn-block" value="{{MAIN_ENTRY_NAME}}" id="main-{{MAIN_ENTRY_NAME/lower/id/option}}-submit" 
                    style="width: 200px; border-radius: 20px;">{{MAIN_ENTRY_NAME/decamelize}}</button>
                    <span class="pr-button-text">{{MAIN_ENTRY_DESCRIPTION/html}}</span>
                </div>
{I:ALT_ENTRY_NAME{              
                <div class="form-group pr-button main-button advanced-button">
                    <button type="button" class="btn btn-primary btn-block" value="{{ALT_ENTRY_NAME}}" id="main-{{ALT_ENTRY_NAME/lower/id/option}}-submit" 
                    style="width: 200px; border-radius: 20px;">{{ALT_ENTRY_NAME/decamelize}}</button>
                    <span class="pr-button-text">{{ALT_ENTRY_DESCRIPTION/html}}</span>
                </div>
}I}
{C:CLI_NODE_NAME{
                <div class="form-group pr-button node-button" id="node-{{CLI_NODE_NAME/lower/id/option}}-button">
                    <button type="button" class="btn btn-primary btn-block" value="{{CLI_METHOD_NAME}}" id="node-{{CLI_NODE_NAME/lower/id/option}}-submit" 

                    style="width: 200px; border-radius: 20px;">{{CLI_METHOD_NAME/decamelize}}</button>
                </div>
}C}
            </div>
        </div>
    </div>
    <!-- Messages Section
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div id="pr-message-panel" class="pr-view-panel">
        <hr>
        <div class="m-4">
            <div class="row" id="pr-message"></div>
            <div class="row" id="pr-message-details"></div>
            <div class="row">
                <div id="pr-timing" class="col-xl-8">
                    <div>
                        <span id="pr-stage-time">
                        </span>
                    </div>
                </div>
                <div class="col-xl-4 float-right">
                    <button class="btn btn-outline-success btn-sm ms-auto mb-2 ms-2" id="download-request" style="display: none;" type="button"><span class="oi oi-data-transfer-download"> Request</span></button>
                    <button class="btn btn-outline-success btn-sm me-2 mb-2" id="download-response" style="display: none;" type="button"><span class="oi oi-data-transfer-download"> Response</span></button>
                </div>
            </div>

        </div>
    </div>
        <div id="pr-extra" class="pr-view-panel"></div>
    <!-- Results Section
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div id="pr-view" class="pr-view-panel">
        <hr>
        <div id="pr-response"></div>
    </div>
    <!-- End Document
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-jsonview/1.2.3/jquery.jsonview.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-json-editor/1.1.0/jquery-json-editor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@2.6.1/dist/jsoneditor.min.js"></script>
    <script>
    var ui_data = {
        "request-schema": {{MAIN_ENTRY_INPUT_SCHEMA_JSON}},
        "request-defaults": {{MAIN_ENTRY_DEFAULTS}},
        "methods": [
            {
                "name": "{{MAIN_ENTRY_NAME}}",
                "url": "{{MAIN_ENTRY_URL}}",
                "response-schema": {{MAIN_ENTRY_OUTPUT_SCHEMA_JSON}}
            }
{I:ALT_ENTRY_NAME{               ,{
                "name": "{{ALT_ENTRY_NAME}}",
                "url": "{{ALT_ENTRY_URL}}",
                "response-schema": {{ALT_ENTRY_OUTPUT_SCHEMA_JSON}},
            }
}I}
        ]
                ,
        "node": [
{C:CLI_NODE_NAME{
            {
                "request-schema": {{CLI_INPUT_SCHEMA_JSON}},
                "response-schema": {{CLI_OUTPUT_SCHEMA_JSON}},
                "name": "{{CLI_NODE_NAME/lower/id/option}}",
                "url": "/-node/{{CLI_NODE_NAME/id/option}}"
             },
}C}
            {
                "name": ".",
                 "url": "/"
            }
        ]
    };
    window.PR = {
        main_page: 1 {A:HAVE_ACTIVE_NODE{-1}A},
        ui_data: null,
        form: null,
        current_node: '',
        advanced_view: 0,
        dark_view: 0,
        have_storage: false,
        init: function(data) {
            PR.ui_data = data;
            try {
                PR.have_storage = 'localStorage' in window && window['localStorage'] !== null;
            } catch (e) {
            }
            if(PR.have_storage) {
                if(typeof localStorage.dark_view !== "undefined")
                    PR.dark_view = localStorage.dark_view;        
                if(typeof localStorage.advanced_view !== "undefined")
                    PR.advanced_view = localStorage.advanced_view;        
            }
            PR.ui_data.node.pop();
        },
        prepareSchema: function(schema) {
            if('type' in schema && !('format' in schema) && schema['type'] === 'string' && !('enum' in schema)) {
                schema['format'] = 'textarea';
            } 
            if('type' in schema && schema['type'] === 'object') {
                properties = schema['properties'];
                for([key, val] of Object.entries(properties)) 
                    PR.prepareSchema(val);
            }
            if('type' in schema && schema['type'] === 'array') {
                PR.prepareSchema(schema['items']);
            }
        },
        advancedFields: [],
        textFields: [],
        hiddenFields: [],
        hiddenLabels: [],
        findAdvancedFields: function(schema, prefix) {
            if('type' in schema && schema['type'] === 'object') {
                properties = schema['properties'];
                for([key, val] of Object.entries(properties)) 
                    PR.findAdvancedFields(val, prefix + '.' + key);
            } else 
            if('type' in schema && schema['type'] === 'array') {
                PR.findAdvancedFields(schema['items'], prefix);
            } else 
            if('type' in schema && 'default' in schema) {
                PR.advancedFields.push(prefix);
            } else
            if('type' in schema && !('default' in schema) && 'format' in schema && schema['format'] === 'textarea') {
                PR.textFields.push(prefix);
            }
        },
        makeForm: function(node_name) {
            if(PR.form != null) {
               PR.form.destroy();
               if(PR.current_node != node_name) {
                   if(PR.current_node === '') {
                       $('.main-button').hide();
                   } else {
                       $('#node-'+PR.current_node+'-button').hide();
                   }
               }
            } else {
               $('.node-button').hide();
            }
            var rqt_schema = PR.ui_data["request-schema"];
            var rqt_defaults = PR.ui_data["request-defaults"];
            for(const n of PR.ui_data.node) if(n.name == node_name) {
                rqt_schema = n["request-schema"];
                rqt_defaults = {};
            }
            rqt_schema["format"] = "grid";
            PR.prepareSchema(rqt_schema);
            if("properties" in rqt_schema)
                PR.findAdvancedFields(rqt_schema, "root");
            PR.form = new JSONEditor($('#pr-form-editor')[0], {
                "schema" : rqt_schema,
                "theme" : "bootstrap4",
                "iconlib" : "openiconic",
                "template" : "handlebars",
                "disable_properties" : true,
                "disable_collapse": true,
                "disable_edit_json" : true
            });
           $('*').removeClass("bg-light");
           if(PR.current_node != node_name) {
               PR.current_node = node_name;
               if(PR.current_node === '') {
                   $('.main-button').show();
               } else {
                   $('#node-'+PR.current_node+'-button').show();
               }
           }
           for(const [key, value] of Object.entries(rqt_defaults)) {
               $('*[data-schemapath="root.'+key+'"] input').val(value);
               $('*[data-schemapath="root.'+key+'"] select').val(value);
               PR.advancedFields.push('root.'+key);
           }
           PR.setDarkView(PR.dark_view);
        },
        appendOrReplace: function(obj, cont, repl) {
            if(repl) {
                obj.replaceWith(cont);
            } else {
                obj.html(obj.html()+cont);
            }
            return obj;
        },
        renderJSON: function(schema, container, label, objectID, jo, replace, keyO) {
            if(typeof jo === 'boolean') {
                PR.appendOrReplace(container, '<div class="pr-JSON-boolean" id="'+objectID+'">'+jo+"</div>", replace);
                if(keyO) keyO.addClass("pr-sticky");
                $("#"+objectID).addClass(label);
            } else 
            if(typeof jo === 'string' || jo instanceof String) {
                PR.appendOrReplace(container, '<div class="pr-JSON-string" id="'+objectID+'"></div>', replace);
                $("#"+objectID).attr('data-text', jo);
                if(keyO && jo.length < 100 && jo.indexOf(' ') < 0) {
                    keyO.addClass("pr-sticky");
                    $("#"+objectID).addClass("pr-sticky");
                    $("#"+objectID).text(jo);
                } else {
                    $("#"+objectID).addClass("pr-wrappable");
                    $("#"+objectID).html(jo.replace(/(?:\r\n|\r|\n)/g, '<br>')); 
                }
                $("#"+objectID).addClass(label);
             } else 
             if(typeof jo === 'number' && isFinite(jo)) {
                 PR.appendOrReplace(container, '<div class="pr-JSON-number" id="'+objectID+'">'+jo+"</div>", replace);
                 if(keyO) keyO.addClass("pr-sticky");
                 $("#"+objectID).addClass(label);
             } else 
             if(jo && typeof jo === 'object' && jo.constructor === Array) {
                 var lc = 0;
                 PR.appendOrReplace(container, '<div class="pr-JSON-array" id="'+objectID+'"></div>', replace);
                 $("#"+objectID).addClass(label);
                 container = $("#"+objectID);
                 if(schema && 'type' in schema && schema['type'] === 'array' && 'items' in schema) 
                     schema = schema['items'];
                 else 
                     schema = null;
                 for(const jao of jo) {
                     lc = lc + 1;
                     var localID = objectID + "-" + lc;
                     PR.renderJSON(schema, container, label, localID, jao, false, null);
                 }
             } else
             if(jo && typeof jo === 'object' && jo.constructor === Object) {
                 var lc = 0;
                 PR.appendOrReplace(container, '<div class="pr-JSON-object" id="'+objectID+'"></div>', replace);
                 $("#"+objectID).addClass(label);
                 container = $("#"+objectID);
                 var properties = null;
                 if(schema && 'type' in schema && schema['type'] === 'object') 
                     properties = schema['properties'];

                 if(properties) {
                     var s = 0;
                     for(const [key, val] of Object.entries(properties)) 
                         if('propertyOrder' in val && val.propertyOrder > s) s = val.propertyOrder; 
                     for([key, val] of Object.entries(properties)) 
                         if(!('propertyOrder' in val)) {val['propertyOrder'] = s; s += 1;} 
                     properties = Array.from(Object.keys(properties), x => [x, properties[x]]);

                     properties.sort(function(a, b) {
                         return a[1].propertyOrder - b[1].propertyOrder;
                     });

                     for(const [key, prop] of properties) {
                         lc = lc + 1;
                         if(key in jo) {
                             var val = jo[key];
                             var localIDk = objectID+'-k'+lc;
                             var localIDv = objectID+'-v'+lc;
                             PR.appendOrReplace(container, '<div class="pr-JSON-key" id="'+localIDk+'"></div><div id="'+localIDv+'"></div>', false);
                             var ko = $("#"+localIDk);
                             ko.text(key); 
                             ko.addClass('k' + label + '-' + key);
                             schema = prop;
                             if('description' in schema) 
                                 ko.attr('title', schema['description']);
                             PR.renderJSON(schema, $("#"+localIDv), label + '-' + key, localIDv, val, true, ko);
                         }
                     }

                 } else {
                     for(const [key, val] of Object.entries(jo)) {
                         lc = lc + 1;
                         var localIDk = objectID+'-k'+lc;
                         var localIDv = objectID+'-v'+lc;
                         PR.appendOrReplace(container, '<div class="pr-JSON-key" id="'+localIDk+'"></div><div id="'+localIDv+'"></div>', false);
                         var ko = $("#"+localIDk);
                         ko.text(key); 
                         ko.addClass('k' + label + '-' + key);
                         if(properties && key in properties) 
                             schema = properties[key];
                         else
                             schema = null;
                         if(schema && 'description' in schema) {                         
                             ko.attr('title', schema['description']);
                         }
                         PR.renderJSON(schema, $("#"+localIDv), label + '-' + key, localIDv, val, true, ko);
                     }
                 }
             } else {
                 PR.appendOrReplace(container, '<div class="pr-JSON-null" id="'+objectID+'">null</div>', replace);
             }
        },

        setDarkView: function(dark_view) {
            var theme = ""
            if(dark_view != 0) {
                theme="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.1.3/darkly/bootstrap.min.css";
                $('#pr-form-editor textarea,#pr-form-editor select,#pr-form-editor input').css('background-color' , '#0F0F0F');
                $('#pr-form-editor textarea,#pr-form-editor select,#pr-form-editor input').css('color' , '#F0F0F0');
            } else {
                theme="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.1.3/flatly/bootstrap.min.css";
                $('#pr-form-editor textarea,#pr-form-editor select,#pr-form-editor input').css('background-color' , '#F0F0F0');
                $('#pr-form-editor textarea,#pr-form-editor select,#pr-form-editor input').css('color' , '#0F0F0F');
            }
            if(PR.have_storage) localStorage.dark_view = dark_view;
            PR.dark_view = dark_view;
            $('link[title="bstheme"]').attr('href', theme);
        },
        connectButtons: function() {
            /* submit on <Return> in the main field if any */
            /*
            $('*[data-schemapath="root.question"]').on("keydown", function(event) {
                var keycode = event.keyCode || event.which;
                if (keycode == 13) {
                    $("#answer_extraction-submit").focus(); 
                    $("#answer_extraction-submit").click();
                    $(this).focus();
                }
            });
            */
            $('#dark-light-view').change(function() { 
                if(this.checked) {
                    PR.setDarkView(1);
                } else {
                    PR.setDarkView(0);
                }
            });
            $('#advanced-view').change(function() { 
                if(this.checked) {
                    for(const tfid of PR.textFields) {
                        $('*[data-schemapath="'+tfid+'"]').removeClass("col-md-12");
                    }
                    for(const afid of PR.advancedFields) {
                        $('*[data-schemapath="'+afid+'"]').show();
                    }
                    $("#pr-message-panel").show();
                    $("#advanced-menu").show();
                    if(PR.current_node === '') {
                        // Show alternate entries when not in node mode
                        $(".advanced-button").show();
                    }
                    // Show hide field labels and values in the reply
                    if(PR.hiddenLabels.length > 0) 
                        $(".km-"+PR.hiddenLabels.join(',.km-')).show();
                    if(PR.hiddenFields.length > 0) {
                        $(".km-"+PR.hiddenFields.join(',.km-')).show();
                        $(".m-"+PR.hiddenFields.join(',.m-')).show();
                    }
                    if(PR.have_storage) localStorage.advanced_view = 1;
                    PR.advanced_view = 1;
                 } else {
                    for(const tfid of PR.textFields) {
                        $('*[data-schemapath="'+tfid+'"]').addClass("col-md-12");
                    }
                    for(const afid of PR.advancedFields) {
                        $('*[data-schemapath="'+afid+'"]').hide();
                    }
                    $("#pr-message-panel").hide();
                    $("#advanced-menu").hide();
                    $(".advanced-button").hide();
                             
                    if(PR.hiddenLabels.length > 0) 
                        $(".km-"+PR.hiddenLabels.join(',.km-')).hide();
                    if(PR.hiddenFields.length > 0) {
                        $(".km-"+PR.hiddenFields.join(',.km-')).hide();
                        $(".m-"+PR.hiddenFields.join(',.m-')).hide();
                    }
                    if(PR.have_storage) localStorage.advanced_view = 0;
                    PR.advanced_view = 0;
                }
            });
            $('.node-item').on('click', function(e) {
                PR.makeForm(this.getAttribute('data-name'));
            });
            $('#download-response').on('click', function() {
                var a = document.createElement("a");
                var docstr = JSON.stringify(PR.response);
                a.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(docstr));
                a.setAttribute('download', "response.json");
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
            $('#download-request').on('click', function() {
                var a = document.createElement("a");
                var docstr = JSON.stringify(PR.request);
                a.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(docstr));
                a.setAttribute('download', "request.json");
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
            $("#clear-button").on("click", function(e) { 
                PR.acedoc = {};
                $("#pr-message").html('');
                $("#pr-stage-time").html('');
                $("#acedoc-view").html('');
                $("#download-response").hide();
                $("#download-request").hide();
            });
            var submit_buttons = [];
            for(const m of PR.ui_data.methods) {
                submit_buttons.push(m);
            }
            for(const n of PR.ui_data.node) {
                submit_buttons.push(n);
            }
            submit_buttons.map(function(m) {
                $("#"+m.name+"-submit").on("click", function(e) { 
                    $('html, body').animate({
                        scrollTop: $("#pr-view").offset().top
                    }, 2000);
                    PR.request = PR.form.getValue();
                    var rqtstr = JSON.stringify(PR.request);
                    try { 
                        var xhr = $.ajax({
                            type: "POST",
                            url: m.url,
                            data: rqtstr,
                            cache: false,
							contentType: "application/json",
                            beforeSend: function(request) {
                                request.setRequestHeader("x-flow-time-call", "true");
                                /*
                                if($('#overlapped-calls').is(":checked")) {
                                    request.setRequestHeader("x-flow-overlapped-calls", "1");
                                } else {
                                    request.setRequestHeader("x-flow-overlapped-calls", "0");
                                }
                                */
                                $("#pr-stage-time").html('');
                                $("#pr-response").html('');
                                $("#pr-message").html('<p class="pr-message-good">Sending request...</p>');
                                $("#download-response").hide();
                                $("#download-request").hide();
                            },
                            success: function(reply_obj, sts, jqxhr) {
                                $("#pr-message").html('');
                                PR.response = reply_obj;
                                PR.responseSchema = m["response-schema"];
                                //PR.beforeRender(m["hidden-fields"], m["hidden-labels"]);
                                PR.renderJSON(PR.responseSchema, $("#pr-response"), "m", "pr-response", reply_obj, true, null);
                                $("#advanced-view").prop("checked", $("#advanced-view").prop("checked")).trigger("change");
                                $('#download-request').show();
                                $('#download-response').show();
                                try {
                                    call_times = jqxhr.getResponseHeader('x-flow-call-times');
                                    call_times = JSON.parse(call_times);
                                    var times_html = '';                    
                                    call_times.forEach(function(to) {
                                         if(to.stage == 0) 
                                            times_html = times_html + " <span class='pr-stage-time'> "+to['stage-name']+": <b>"+to['duration-u']+"</b> </span>";
                                    });
                                    if(call_times.length > 2) call_times.forEach(function(to) {
                                        if(to.stage != 0) {             
                                            times_html = times_html + " <span class='pr-stage-time'> "+to['stage-name']+": <b>"+to['duration-u']+"</b> </span>";
                                        }
                                    });
                                    $("#pr-stage-time").html(times_html);
                                                          
                                } catch(ae) {
                                }
                                PR.afterRender();
                                $('html, body').animate({
                                    scrollTop: $("#pr-view").offset().top
                                }, 2000);
                            },
							error: function(jqXHR, sts, exc) {
                                var emsg = (sts == null ? "error" : sts);
                                if(jqXHR.responseJSON != undefined) {
                                    emsg = jqXHR.responseJSON;
                                }
                                var details = '';
                                if(emsg && typeof emsg === 'object' && emsg.constructor === Object) {
                                    if('code' in emsg && emsg['code'] == 500) {
                                        details = emsg["details"]; 
                                        emsg = '[' + emsg["from"] + '] gRPC Error ' + emsg["grpc-code"] + ': ' + emsg['message'];
                                    } else {
                                        emsg = JSON.stringify(emsg);
                                    }
                                }
                                PR.printError(emsg, details);
                            }
                        });
					} catch (ae) {
						PR.printError("system error");
					}
                    
                });
            });
        },
        printError: function(msg, description) {
            alert(msg+'\n'+description);
            $("#pr-message").html('<p class="pr-message-error">'+msg+"</p>");
            $("#pr-message-details").text(description);
        },
        /***
         * PR.request, PR.response and PR.responseSchema are set 
         * for both beforeRender and afterRender
         */
        fieldNamesToClassNames: function(str) {
            str = str.replace(/[ ,]+/gi, ',').replace(/^[ ,]+|[ .,]+$/gi, '').replace(/[.]/gi, '-');
            str = str.replace(/_[A-za-z]/gi, function(c) { return c.substr(1).toUpperCase(); })
            return str.split(',');
        },
        beforeRender: function(hiddenFields, hiddenLabels) {
            PR.hiddenFields = PR.fieldNamesToClassNames(hiddenFields);
            PR.hiddenLabels = PR.fieldNamesToClassNames(hiddenLabels);
        },
        afterRender: function() {
        }
    };
    PR.init(ui_data);
    PR.makeForm("");
    PR.connectButtons();

    if(PR.advanced_view != 0) {
        $("#advanced-view").prop("checked", 1).trigger("change");
    } else {
        $("#advanced-view").prop("checked", 0).trigger("change");
    }
    if(PR.dark_view != 0) {
        $("#dark-light-view").prop("checked", 1).trigger("change");
    } else {
        $("#dark-light-view").prop("checked", 0).trigger("change");
    }
    </script>
</body>
</html>
