# Quick Start
The flow-compiler is written in **C++** and uses a variety of open source components. The generated code also has dependencies on open source libraries. 

The first step is to install the required components:

    - **C++** compiler that supports the *c++11* standard
    - **gRPC** libraries and the **gRPC** compiler wit **C++** plugin. Details for C++ for your platform can be found here: [grpc.io](https://grpc.io/docs/languages/cpp/quickstart)
    - **dot**, from the **graphviz** toolkit. Details are here: [graphviz.org](http://www.graphviz.org)

      
## gRPC compiler with C++ plugin

For detailed instructions on building and using gRPC see https://grpc.io

### On macOs with brew:
```bash
brew install grpc
```

### On Linux:
```bash
git clone -b $(curl -L https://grpc.io/release) https://github.com/grpc/grpc
cd grpc && git submodule update --init 
mkdir -p cmake/build && cd cmake/build 
cmake -DgRPC_INSTALL=ON -DgRPC_BUILD_TESTS=OFF ../.. 
make -j$(nproc) 
make install 
```
## Lemon (optional)
The parser for the flow compiler (defined in [flow-parser.Y](flow-parser.Y)) is generated with **lemon**. The generated files are checked in, so **lemon** is only needed if you make changes to the parser.

More information about **lemon** can be found here [http://www.hwaci.com/sw/lemon/](http://www.hwaci.com/sw/lemon/)
```bash 
make lemon 
echo "LEMON=./lemon" >> makefile.local
```

### On macOS with brew:
```bash
brew install lemon
```


## Docker and Docker Compose
**Docker** is needed for creating a container image with the application. The image can be run by istelf or deployed with **Docker Compose**, **Docker Swarm** or **Kubernetes**.

**Docker** instructions are here [https://docs.docker.com/install/](https://docs.docker.com/install/) and **Docker Compose** instructions are here [https://docs.docker.com/compose/install/](https://docs.docker.com/compose/install/).


## kubectl
**kubectl** is the necessary tool to interact with **Kubernetes** clusters. The deployment tool generated by **flowc** uses **kubectl**. 

Installation instructions can be found here: [https://kubernetes.io/docs/tasks/tools/install-kubectl/](https://kubernetes.io/docs/tasks/tools/install-kubectl/)

## graphviz
**dot**, from the **graphviz** toolkit is used to generate a call flow diagram. Details can be found here: [http://www.graphviz.org](http://www.graphviz.org)

# Installation

Follow these two steps to get ready to build an application. The second step is olny necessary if the final orchestrator application is to be run in its own **docker** container.

# Build (and Install) flowc
```bash        
make
sudo make install INSTALL_PREFIX=/usr/local/bin 
```

# Build the Docker Image
Applications can be encapsulated in their own **docker** image. An image that contains **flowc** is neeed as a base for any application image. This image can be based on one of the following linux distributions: Ubuntu 18.04 and 20.04, Alpine 3.12 and 3.13, and Redhat UBI7 and 8. By default Redhat UBI8 is used.
To build the default **flowc** image: 
```bash
make image
```
To build a specific **flowc** image, chose oneof these targets `alpine-3.12`, `alpine-3.13`, `redhat-ubi7`, `redhat-ubi8`, `ubuntu-18.04` or `ubuntu-20.04`: 
```bash
make alpine-3.13
```

# Building and Running an Aggregator

See here [how to](../HOWTO-FLOW.md) construct a flow application.

This will generate the **gRPC** server code for aggregator application. All files will be written in the current directory.
A different output directory can be specified with **-o**
```bash
flowc my-project.flow --server
```    
Make sure to let **flowc** know about the location of all the included **.proto** files with the **-I** option:
```bash
flowc -I proto-dir my-project --server
```

The application server binary can be built using the generated **makefile** or by running **flowc** with the **--build-server** option.

To build the **docker** image that contains the application, use option **--build-image**. This will build an image tagged **_my-project:1_**:
```bash
flowc my-project.flow --build-image
```    
